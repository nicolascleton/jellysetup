---
# =============================================================================
# Docker Compose - Media Stack
# Generated by JellySetup
# Pi: {{ pi_name }}
# IP: {{ pi_ip }}
# =============================================================================

services:
  # ===========================================================================
  # Decypharr - AllDebrid manager + WebDAV/Rclone mount
  # ===========================================================================
  decypharr:
    image: cy01/blackhole:latest
    container_name: decypharr
    restart: always
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    ports:
      - 8282:8282
    volumes:
      - /mnt:/mnt:rshared
      - /mnt/decypharr/qbit:/mnt/decypharr/qbit
      - ./decypharr:/app
    environment:
      - TZ=Europe/Paris
      - PUID=1000
      - PGID=1000
    devices:
      - /dev/fuse:/dev/fuse:rwm

  # ===========================================================================
  # Jellyfin - Main media server
  # ===========================================================================
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    ports:
      - 8096:8096
    environment:
      - TZ=Europe/Paris
      - PUID=1000
      - PGID=1000
      - JELLYFIN_FFmpeg__probesize=1G
      - JELLYFIN_FFmpeg__analyzeduration=200M
    volumes:
      - ./jellyfin:/config
      - /mnt:/mnt:rshared
    devices:
      - /dev/dri:/dev/dri
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================================================
  # Radarr - Movie manager
  # ===========================================================================
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - 7878:7878
    volumes:
      - ./radarr:/config
      - /mnt:/mnt:rslave
    environment:
      - TZ=Europe/Paris
      - PUID=1000
      - PGID=1000

  # ===========================================================================
  # Sonarr - TV series manager
  # ===========================================================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - 8989:8989
    volumes:
      - ./sonarr:/config
      - /mnt:/mnt:rslave
    environment:
      - TZ=Europe/Paris
      - PUID=1000
      - PGID=1000

  # ===========================================================================
  # Prowlarr - Indexer manager
  # ===========================================================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - 9696:9696
    volumes:
      - ./prowlarr:/config
    environment:
      - TZ=Europe/Paris
      - PUID=1000
      - PGID=1000

  # ===========================================================================
  # Jellyseerr - Request interface for Jellyfin
  # ===========================================================================
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    ports:
      - 5055:5055
    volumes:
      - ./jellyseerr:/app/config
    environment:
      - TZ=Europe/Paris

  # ===========================================================================
  # Bazarr - Subtitle manager
  # ===========================================================================
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    ports:
      - 6767:6767
    environment:
      - TZ=Europe/Paris
      - PUID=1000
      - PGID=1000
    volumes:
      - ./bazarr:/config
      - /mnt:/mnt:rslave

  # ===========================================================================
  # FlareSolverr - Cloudflare bypass for indexers
  # ===========================================================================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    ports:
      - 8191:8191
    environment:
      - TZ=Europe/Paris
      - LOG_LEVEL=info

{% if cloudflare_token is defined and cloudflare_token != "" %}
  # ===========================================================================
  # Cloudflared - Cloudflare tunnel for remote access
  # ===========================================================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate --protocol http2 run
    environment:
      - TUNNEL_TOKEN={{ cloudflare_token }}
{% endif %}

networks:
  default:
    name: media-network
